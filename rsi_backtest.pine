//@version=5
strategy("RSI 101 Backtest", overlay=false, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// --- Inputs ---
// Strategy Inputs
rsiLength = input.int(14, "RSI Length", group="Strategy")
wmaLength = input.int(45, "WMA Length (on RSI)", group="Strategy")
emaLength = input.int(9, "EMA Length (on RSI)", group="Strategy")
useHTF = input.bool(true, "Use Higher Timeframe Filter?", group="Strategy")
htfResolution = input.timeframe("D", "Higher Timeframe", group="Strategy")

// Risk Management Inputs
useSLTP = input.bool(true, "Use SL/TP?", group="Risk Management")
slPoints = input.int(500, "Stop Loss (Points)", tooltip="500 points = 50 pips (for Gold)", group="Risk Management")
tpPoints = input.int(1000, "Take Profit (Points)", tooltip="1000 points = 100 pips", group="Risk Management")

// --- Calculations ---
rsiValue = ta.rsi(close, rsiLength)
wmaValue = ta.wma(rsiValue, wmaLength)
emaValue = ta.ema(rsiValue, emaLength)

// Plotting
plot(rsiValue, "RSI", color=color.purple, linewidth=2)
plot(wmaValue, "WMA 45", color=color.yellow, linewidth=2)
plot(emaValue, "EMA 9", color=color.blue, linewidth=1)

// Levels
hline(75, "Overbought", color=color.red, linestyle=hline.style_dashed)
hline(25, "Oversold", color=color.green, linestyle=hline.style_dashed)
hline(60, "Bullish Zone Start", color=color.gray, linestyle=hline.style_dotted)
hline(40, "Bearish Zone Start", color=color.gray, linestyle=hline.style_dotted)

// HTF Calculations
htfRsiValue = request.security(syminfo.tickerid, htfResolution, ta.rsi(close, rsiLength))
htfTrendUp = htfRsiValue > 50
htfTrendDown = htfRsiValue < 50

// Signals
// Buy: RSI crosses over WMA45. Confirmation if RSI > EMA9.
buySignalRaw = ta.crossover(rsiValue, wmaValue) and rsiValue > emaValue
// Sell: RSI crosses under WMA45. Confirmation if RSI < EMA9.
sellSignalRaw = ta.crossunder(rsiValue, wmaValue) and rsiValue < emaValue

// Apply HTF Filter
buySignal = buySignalRaw and (not useHTF or htfTrendUp)
sellSignal = sellSignalRaw and (not useHTF or htfTrendDown)

// Strategy Execution
if (buySignal)
    strategy.entry("Long", strategy.long)

if (sellSignal)
    strategy.entry("Short", strategy.short)

// Exit Logic (SL/TP)
if (useSLTP)
    strategy.exit("Exit Long", "Long", loss=slPoints, profit=tpPoints)
    strategy.exit("Exit Short", "Short", loss=slPoints, profit=tpPoints)

// Close opposite on signal (optional, but standard for reversal strategies)
// Note: strategy.entry automatically reverses position if you are in opposite direction, 
// unless you use hedging. Default is netting.
